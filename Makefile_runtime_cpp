SHELL=/bin/sh

BASE     = test_runtime_cpp
MAKEFILE = Makefile_runtime_cpp
BASEDIR  = .
INCDIR   = $(BASEDIR)/includes
SRCDIR   = $(BASEDIR)/src
TESTDIR  = $(BASEDIR)/test
AMREXDIR = $(HOME)/Projects/amrex_install/2D
GTESTDIR = /usr/local/spack/opt/spack/darwin-highsierra-x86_64/gcc-6.5.0/googletest-1.8.1-6y5spjfzq4uiazxbcb7sw3qrloxbrhgw

# Common files
CXX_HDRS   = \
    $(INCDIR)/Tile.h \
    $(INCDIR)/runtimeTask.h \
    $(INCDIR)/ThreadTeamModes.h \
    $(INCDIR)/ThreadTeam.h \
    $(INCDIR)/ThreadTeamState.h \
    $(INCDIR)/ThreadTeamIdle.h \
    $(INCDIR)/ThreadTeamTerminating.h \
    $(INCDIR)/ThreadTeamRunningOpen.h \
    $(INCDIR)/ThreadTeamRunningClosed.h \
    $(INCDIR)/ThreadTeamRunningNoMoreWork.h \
    $(INCDIR)/OrchestrationRuntime.h \
    $(TESTDIR)/Flash.h \
    $(TESTDIR)/constants.h \
    $(TESTDIR)/computeLaplacianDensity_cpu.h \
    $(TESTDIR)/computeLaplacianEnergy_cpu.h \
    $(TESTDIR)/scaleEnergy_cpu.h
SRCS       = \
    $(SRCDIR)/Tile.cpp \
    $(TESTDIR)/testRuntimeInt.cpp \
    $(TESTDIR)/testRuntimeTile.cpp \
    $(TESTDIR)/computeLaplacianDensity_cpu.cpp \
    $(TESTDIR)/computeLaplacianEnergy_cpu.cpp \
    $(TESTDIR)/scaleEnergy_cpu.cpp \
    $(TESTDIR)/runAllCppTests.cpp

OBJS      = $(addsuffix .o, $(basename $(SRCS)))
COMMAND   =  $(BASE).x

CXX       = mpicxx
CXXFLAGS  = -g -O0 -I$(INCDIR) -I$(TESTDIR) -I$(AMREXDIR)/include -I$(GTESTDIR)/include -std=c++11
CXXWARNS  =

LIBS      = -lstdc++ -lamrex -lgtest -lgtest_main
LDFLAGS   = -L$(AMREXDIR)/lib -L$(GTESTDIR)/lib

ifdef DEBUG
CXXFLAGS := $(CXXFLAGS) -DDEBUG_RUNTIME
endif

all:    $(COMMAND)

.SUFFIXES:
.SUFFIXES: .o .cpp

$(COMMAND): $(OBJS) $(MAKEFILE) 
	$(CXX) -o $(COMMAND) $(OBJS) $(LDFLAGS) $(LIBS)

.cpp.o: $(CXX_HDRS) $(MAKEFILE)
	$(CXX) -c $(CXXFLAGS) $(CXXWARNS) -o $@ $<

clean:
	/bin/rm -f $(COMMAND) $(BASEDIR)/Test*.log
	/bin/rm -f $(COMMAND) $(SRCDIR)/*.o
	/bin/rm -f $(COMMAND) $(TESTDIR)/*.o
	/bin/rm -f $(COMMAND) $(SRCDIR)/*.mod
	/bin/rm -f $(COMMAND) $(BASEDIR)/*.mod
	/bin/rm -f $(COMMAND) $(TESTDIR)/*.mod

