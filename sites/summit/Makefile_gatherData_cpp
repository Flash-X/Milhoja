SHELL=/bin/sh

# TODO: Redo this with more care.  Make certain that template .h/.cpp dependencies are correct

BASE         = gather_data_cpp
MAKEFILE     = Makefile_gatherData_cpp
BASEDIR      = ../..
INCDIR       = $(BASEDIR)/includes
SRCDIR       = $(BASEDIR)/src
TESTBASEDIR  = $(BASEDIR)/test/Base
TESTDIR      = $(BASEDIR)/test/GatherDataCpp
AMREXDIR     = $(HOME)/local/pgi_19.9/AMReX_2d
CUDADIR      = $(OLCF_CUDA_ROOT)
PGIDIR       = $(OLCF_PGI_ROOT)/linuxpower/19.9

# Common files
CXX_HDRS   = \
    $(INCDIR)/FArray1D.h \
    $(INCDIR)/FArray4D.h \
    $(INCDIR)/Tile.h \
    $(INCDIR)/TileAmrex.h \
    $(INCDIR)/TileIter.h \
    $(INCDIR)/TileIterAmrex.h \
    $(INCDIR)/Grid_IntVect.h \
    $(INCDIR)/Grid_RealVect.h \
    $(INCDIR)/Grid.h \
    $(INCDIR)/GridAmrex.h \
    $(INCDIR)/Grid_AmrCoreFlash.h \
    $(INCDIR)/actionRoutine.h \
    $(INCDIR)/OrchestrationLogger.h \
    $(INCDIR)/ThreadTeamModes.h \
    $(INCDIR)/ThreadTeamDataType.h \
    $(INCDIR)/ThreadTeam.h \
    $(INCDIR)/ThreadTeamState.h \
    $(INCDIR)/ThreadTeamIdle.h \
    $(INCDIR)/ThreadTeamTerminating.h \
    $(INCDIR)/ThreadTeamRunningOpen.h \
    $(INCDIR)/ThreadTeamRunningClosed.h \
    $(INCDIR)/ThreadTeamRunningNoMoreWork.h \
    $(INCDIR)/DataItem.h \
    $(INCDIR)/DataPacket.h \
    $(INCDIR)/RuntimeElement.h \
    $(INCDIR)/RuntimeAction.h \
    $(INCDIR)/ActionBundle.h \
    $(INCDIR)/Runtime.h \
    $(TESTBASEDIR)/setInitialConditions.h \
    $(TESTBASEDIR)/computeLaplacianDensity.h \
    $(TESTBASEDIR)/computeLaplacianEnergy.h \
    $(TESTBASEDIR)/scaleEnergy.h \
    $(TESTBASEDIR)/Analysis.h
CU_HDRS   = \
    $(INCDIR)/CudaGpuEnvironment.h \
    $(INCDIR)/CudaDataPacket.h \
    $(INCDIR)/CudaStream.h \
    $(INCDIR)/CudaStreamManager.h \
    $(INCDIR)/CudaMemoryManager.h
SRCS       = \
    $(SRCDIR)/RuntimeElement.cpp \
    $(SRCDIR)/ThreadTeam.cpp \
    $(SRCDIR)/ThreadTeamIdle.cpp \
    $(SRCDIR)/ThreadTeamTerminating.cpp \
    $(SRCDIR)/ThreadTeamRunningOpen.cpp \
    $(SRCDIR)/ThreadTeamRunningClosed.cpp \
    $(SRCDIR)/ThreadTeamRunningNoMoreWork.cpp \
    $(SRCDIR)/FArray1D.cpp \
    $(SRCDIR)/FArray4D.cpp \
    $(SRCDIR)/Tile.cpp \
    $(SRCDIR)/TileAmrex.cpp \
    $(SRCDIR)/Grid_IntVect.cpp \
    $(SRCDIR)/Grid_RealVect.cpp \
    $(SRCDIR)/DataPacket.cpp \
    $(SRCDIR)/Grid.cpp \
    $(SRCDIR)/GridAmrex.cpp \
    $(SRCDIR)/Grid_AmrCoreFlash.cpp \
    $(SRCDIR)/OrchestrationLogger.cpp \
    $(SRCDIR)/MoverUnpacker.cpp \
    $(SRCDIR)/CudaStream.cpp \
    $(SRCDIR)/Runtime.cpp \
    $(TESTBASEDIR)/setInitialConditions.cpp \
    $(TESTBASEDIR)/setInitialConditions_tile_cpu.cpp \
    $(TESTBASEDIR)/computeLaplacianDensity.cpp \
    $(TESTBASEDIR)/computeLaplacianDensity_tile_cpu.cpp \
    $(TESTBASEDIR)/computeLaplacianEnergy.cpp \
    $(TESTBASEDIR)/computeLaplacianEnergy_tile_cpu.cpp \
    $(TESTBASEDIR)/computeLaplacianEnergy_oacc_summit.cpp \
    $(TESTBASEDIR)/computeLaplacianEnergy_packet_oacc_summit.cpp \
    $(TESTBASEDIR)/scaleEnergy.cpp \
    $(TESTBASEDIR)/scaleEnergy_tile_cpu.cpp \
    $(TESTBASEDIR)/Analysis.cpp \
    $(TESTDIR)/gatherData.cpp 
CU_SRCS       = \
    $(SRCDIR)/CudaGpuEnvironment.cu \
    $(SRCDIR)/CudaDataPacket.cu \
    $(SRCDIR)/CudaStreamManager.cu \
    $(SRCDIR)/CudaMemoryManager.cu

OBJS      = $(addsuffix .o, $(basename $(SRCS)))
CUOBJS    = $(addsuffix .o, $(basename $(CU_SRCS)))
COMMAND   =  $(BASE).x

OACC_FLAGS = -acc -ta=tesla:cc70,cuda10.1,ptxinfo -Minfo=accel

CXX       = mpicxx
CXXFLAGS  = -g -O0 -traceback -std=c++11  -I$(INCDIR) -I$(TESTDIR) -I$(TESTBASEDIR) -I$(AMREXDIR)/include $(OACC_FLAGS) -DUSE_CUDA_BACKEND -DENABLE_OPENACC_OFFLOAD
CXXWARNS  =

CU        = nvcc
CUFLAGS   = -ccbin=pgc++ -g -O0 -std=c++11 -m64 -gencode arch=compute_70,code=sm_70 -I$(PGIDIR)/include -I$(INCDIR) -I$(TESTDIR) -I$(TESTBASEDIR) -I$(AMREXDIR)/include -DUSE_CUDA_BACKEND -DENABLE_OPENACC_OFFLOAD -D__PGI
CUWARNS   =

LIBS      = -lpthread -lstdc++ -pgf90libs -lamrex -lcudart
LDFLAGS   = -L$(AMREXDIR)/lib -L$(CUDADIR)/lib64 -L$(PGIDIR)/lib

all:    $(COMMAND)

.SUFFIXES:
.SUFFIXES: .o .cpp .cu

$(COMMAND): $(OBJS) $(CUOBJS) $(MAKEFILE) 
	$(CXX) -o $(COMMAND) $(OBJS) $(CUOBJS) $(LDFLAGS) $(LIBS) $(OACC_FLAGS)

# Move buildInfo.h out so that we just write it once
# Also, find commands that are universal
.cpp.o: $(CXX_HDRS) $(MAKEFILE)
	@/bin/rm -f $(TESTDIR)/buildInfo.h
	@printf "constexpr char PROJECT_GIT_REPO_NAME[] = \"" >> $(TESTDIR)/buildInfo.h
	@printf "%s\";\n" `git config --get remote.origin.url` >> $(TESTDIR)/buildInfo.h

	@printf "constexpr char PROJECT_GIT_REPO_VER[] = \"" >> $(TESTDIR)/buildInfo.h
	@printf "%s\";\n" `git -C $(SRCDIR) describe --always` >> $(TESTDIR)/buildInfo.h

	@printf "constexpr char BUILD_DATETIME[] = \"" >> $(TESTDIR)/buildInfo.h
	@printf "%s\";\n" `date +"%Y-%m-%dT%H:%M:%S%z"` >> $(TESTDIR)/buildInfo.h

	@printf "constexpr char HOSTNAME[] = \"" >> $(TESTDIR)/buildInfo.h
	@printf "%s\";\n" `hostname` >> $(TESTDIR)/buildInfo.h

#	@printf "constexpr char MACHINE_INFO[] = \"" >> $(TESTDIR)/buildInfo.h
#	@printf "%s\";\n" `$(CXX) -dumpmachine` >> $(TESTDIR)/buildInfo.h

	@printf "constexpr char CXX_COMPILER[] = \"" >> $(TESTDIR)/buildInfo.h
	@printf "%s\";\n" $(CXX) >> $(TESTDIR)/buildInfo.h

#	@printf "constexpr char CXX_COMPILER_VERSION[] = \"" >> $(TESTDIR)/buildInfo.h
#	@printf "%s\";\n" `$(CXX) -dumpversion` >> $(TESTDIR)/buildInfo.h

	$(CXX) -c $(CXXFLAGS) $(CXXWARNS) -o $@ $<

.cu.o: $(CU_HDRS) $(MAKEFILE)
	$(CU) -c $(CUFLAGS) $(CUWARNS) -o $@ $<

clean:
	/bin/rm -f $(COMMAND)
	/bin/rm -f *.mod
	/bin/rm -f $(SRCDIR)/*.o
	/bin/rm -f $(SRCDIR)/*.mod
	/bin/rm -f $(TESTBASEDIR)/*.o
	/bin/rm -f $(TESTDIR)/buildInfo.h
	/bin/rm -f $(TESTDIR)/*.o
	/bin/rm -f $(TESTDIR)/*.mod

