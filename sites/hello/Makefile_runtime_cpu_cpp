SHELL=/bin/sh

# TODO: Redo this with more care.  Make certain that template .h/.cpp dependencies are correct

BASE            = test_runtime_cpu_cpp
MAKEFILE        = Makefile_runtime_cpu_cpp
BASEDIR         = ../..
INCDIR          = $(BASEDIR)/includes
SRCDIR          = $(BASEDIR)/src
TESTBASEDIR     = $(BASEDIR)/test/Base
TESTDIR         = $(BASEDIR)/test/Runtime
# Site managers should specify where both forms of the library are if the test
# has the possibility of being run with and without multithreaded distributors.
# Note, I tried to build a non-OMP version of this test using the OMP version of
# AMReX, and compilation aborted.  TODO: Does this mean that the test designers
# are responsible for ensuring that the site managers provide both?  Should we
# always insist that all sites specify both even if one is always empty?
AMREXDIR_OMP    = $(HOME)/local/gcc_6.5.0/AMReX_2D_OpenMP
AMREXDIR_NO_OMP = $(HOME)/local/gcc_6.5.0/AMReX_2D_noOpenMP

GTESTDIR     = /usr/local/spack/opt/spack/darwin-highsierra-x86_64/gcc-6.5.0/googletest-1.8.1-6y5spjfzq4uiazxbcb7sw3qrloxbrhgw

# Common files
CXX_HDRS   = \
    $(INCDIR)/RuntimeElement.h \
    $(INCDIR)/ThreadTeamModes.h \
    $(INCDIR)/ThreadTeamDataType.h \
    $(INCDIR)/ThreadTeam.h \
    $(INCDIR)/ThreadTeamState.h \
    $(INCDIR)/ThreadTeamIdle.h \
    $(INCDIR)/ThreadTeamTerminating.h \
    $(INCDIR)/ThreadTeamRunningOpen.h \
    $(INCDIR)/ThreadTeamRunningClosed.h \
    $(INCDIR)/ThreadTeamRunningNoMoreWork.h \
    $(INCDIR)/FArray1D.h \
    $(INCDIR)/FArray4D.h \
    $(INCDIR)/Tile.h \
    $(INCDIR)/TileAmrex.h \
    $(INCDIR)/TileIter.h \
    $(INCDIR)/TileIterAmrex.h \
    $(INCDIR)/Grid_IntVect.h \
    $(INCDIR)/Grid_RealVect.h \
    $(INCDIR)/Grid.h \
    $(INCDIR)/GridAmrex.h \
    $(INCDIR)/Grid_AmrCoreFlash.h \
    $(INCDIR)/actionRoutine.h \
    $(INCDIR)/RuntimeAction.h \
    $(INCDIR)/DataItem.h \
    $(INCDIR)/OrchestrationLogger.h \
    $(INCDIR)/Stream.h \
    $(INCDIR)/StreamManager.h \
    $(INCDIR)/NullStreamManager.h \
    $(INCDIR)/Runtime.h \
    $(TESTBASEDIR)/setInitialConditions.h \
    $(TESTBASEDIR)/errorEstBlank.h \
    $(TESTBASEDIR)/computeLaplacianDensity.h \
    $(TESTBASEDIR)/computeLaplacianEnergy.h \
    $(TESTBASEDIR)/computeLaplacianFused.h \
    $(TESTBASEDIR)/Analysis.h
SRCS       = \
    $(SRCDIR)/RuntimeElement.cpp \
    $(SRCDIR)/ThreadTeam.cpp \
    $(SRCDIR)/ThreadTeamIdle.cpp \
    $(SRCDIR)/ThreadTeamTerminating.cpp \
    $(SRCDIR)/ThreadTeamRunningOpen.cpp \
    $(SRCDIR)/ThreadTeamRunningClosed.cpp \
    $(SRCDIR)/ThreadTeamRunningNoMoreWork.cpp \
    $(SRCDIR)/FArray1D.cpp \
    $(SRCDIR)/FArray4D.cpp \
    $(SRCDIR)/Tile.cpp \
    $(SRCDIR)/TileAmrex.cpp \
    $(SRCDIR)/Grid_IntVect.cpp \
    $(SRCDIR)/Grid_RealVect.cpp \
    $(SRCDIR)/Grid.cpp \
    $(SRCDIR)/GridAmrex.cpp \
    $(SRCDIR)/Grid_AmrCoreFlash.cpp \
    $(SRCDIR)/OrchestrationLogger.cpp \
    $(SRCDIR)/StreamManager.cpp \
    $(SRCDIR)/Runtime.cpp \
    $(TESTBASEDIR)/setInitialConditions.cpp \
    $(TESTBASEDIR)/setInitialConditions_tile_cpu.cpp \
    $(TESTBASEDIR)/errorEstBlank.cpp \
    $(TESTBASEDIR)/computeLaplacianDensity.cpp \
    $(TESTBASEDIR)/computeLaplacianDensity_tile_cpu.cpp \
    $(TESTBASEDIR)/computeLaplacianEnergy.cpp \
    $(TESTBASEDIR)/computeLaplacianEnergy_tile_cpu.cpp \
    $(TESTBASEDIR)/computeLaplacianFusedKernels.cpp \
    $(TESTBASEDIR)/computeLaplacianFusedKernels_tile_cpu.cpp \
    $(TESTBASEDIR)/Analysis.cpp \
    $(TESTDIR)/testRuntime.cpp \
    $(TESTDIR)/runRuntimeTests.cpp

OBJS      = $(addsuffix .o, $(basename $(SRCS)))
COMMAND   =  $(BASE).x

# Site managers know what information is needed to build with OpenMP, so they
# should specify this.
OMP_FLAGS = -fopenmp

ifdef THREADED_DISTRIBUTOR
AMREXDIR  = $(AMREXDIR_OMP)
else
# Override site manager info if OpenMP is not needed for multithreaded
# distributor
OMP_FLAGS =
AMREXDIR  = $(AMREXDIR_NO_OMP)
endif

CXX       = mpicxx
CXXFLAGS  = -g -O0 -std=c++11 $(OMP_FLAGS) -I$(INCDIR) -I$(TESTBASEDIR) -I$(TESTDIR) -I$(AMREXDIR)/include -I$(GTESTDIR)/include
CXXWARNS  =

LIBS      = -lpthread -lstdc++ -lgomp -lamrex -lgtest
LDFLAGS   = -L$(AMREXDIR)/lib -L$(GTESTDIR)/lib

ifdef DEBUG
CXXFLAGS := $(CXXFLAGS) -DDEBUG_RUNTIME
endif

all:    $(COMMAND)

.SUFFIXES:
.SUFFIXES: .o .cpp

$(COMMAND): $(OBJS) $(MAKEFILE) 
	$(CXX) -o $(COMMAND) $(OBJS) $(LDFLAGS) $(LIBS)

.cpp.o: $(CXX_HDRS) $(MAKEFILE)
	$(CXX) -c $(CXXFLAGS) $(CXXWARNS) -o $@ $<

clean:
	/bin/rm -f Test*.log
	/bin/rm -f $(SRCDIR)/*.o
	/bin/rm -f $(TESTBASEDIR)/*.o
	/bin/rm -f $(TESTDIR)/*.o
	/bin/rm -f $(BASEDIR)/test_*.x 

