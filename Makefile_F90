SHELL=/bin/sh

##### MIMIC SETUP STAGE/RUNTIME PARAMETERS HERE
# These define default values, but selection can also be made at
# command line.
#
# Ex. The full featured test of the Orchestration System prototype
#    make clean all RUNTIME=CUDA VERBOSITY=SILENT
#

#
# Choose between 
# - running a serial invocation (CPU-only node operation) or
# - running a parallel invocation (CPU/Multi-GPU node operation)
#
ifndef RUNTIME
RUNTIME=CPU_ONLY
#RUNTIME=CUDA
endif

#
# Enable/Disable verbose logging of orchestration runtime sequence
#
ifndef VERBOSITY
VERBOSITY=VERBOSE
#VERBOSITY=SILENT
endif

BASE     = test_runtime_f90
BASEDIR  = .
INCDIR   = $(BASEDIR)/includes
SRCDIR   = $(BASEDIR)/src
TESTDIR  = $(BASEDIR)/test
AMREXDIR = $(HOME)/Projects/amrex_install/2D

# Common files
CXX_HDRS   = \
    $(INCDIR)/Tile.h \
    $(INCDIR)/Grid.h \
    $(INCDIR)/runtimeTask.h \
    $(INCDIR)/ThreadTeamModes.h \
    $(INCDIR)/ThreadTeam.h \
    $(INCDIR)/ThreadTeamState.h \
    $(INCDIR)/ThreadTeamIdle.h \
    $(INCDIR)/ThreadTeamTerminating.h \
    $(INCDIR)/ThreadTeamRunningOpen.h \
    $(INCDIR)/ThreadTeamRunningClosed.h \
    $(INCDIR)/ThreadTeamRunningNoMoreWork.h \
    $(INCDIR)/OrchestrationRuntime.h \
    $(TESTDIR)/constants.h
CXX_SRCS       = \
    $(SRCDIR)/Tile.cpp \
    $(SRCDIR)/tile_fi.cpp \
    $(SRCDIR)/grid_fi.cpp \
    $(SRCDIR)/orchestration_runtime_fi.cpp
F90_SRCS       = \
    $(SRCDIR)/tile_mod.F90 \
    $(SRCDIR)/Grid_interface.F90 \
    $(SRCDIR)/Orchestration_interface.F90 \
    $(TESTDIR)/Simulation_interface.F90 \
    $(TESTDIR)/Analysis_interface.F90 \
    $(TESTDIR)/Simulation_initBlock.F90 \
    $(SRCDIR)/Grid_data.F90 \
    $(SRCDIR)/Orchestration_data.F90 \
    $(TESTDIR)/Analysis_data.F90 \
    $(SRCDIR)/Grid_init.F90 \
    $(SRCDIR)/Grid_initDomain.F90 \
    $(SRCDIR)/Grid_getDomainBoundBox.F90 \
    $(SRCDIR)/Grid_getDeltas.F90 \
    $(SRCDIR)/Grid_getCellCoords.F90 \
    $(SRCDIR)/Grid_finalize.F90 \
    $(SRCDIR)/Orchestration_init.F90 \
    $(SRCDIR)/Orchestration_finalize.F90 \
    $(SRCDIR)/Orchestration_executeTasks.F90 \
    $(TESTDIR)/Driver_evolveFlash.F90 \
    $(TESTDIR)/Analysis_computeErrors.F90

OBJS      = $(addsuffix .o, $(basename $(CXX_SRCS)))
MODS      = $(addsuffix .mod, $(basename $(F90_SRCS)))
MAKEFILE  = Makefile_F90
COMMAND   =  $(BASE).x

CXX       = mpicxx
CXXFLAGS  = -g -O0 -I$(INCDIR) -I$(TESTDIR) -I$(AMREXDIR)/include -std=c++11 -D$(RUNTIME) -D$(VERBOSITY)
CXXWARNS  =

F90       = mpif90
F90FLAGS  = -g -O0 -cpp -I$(TESTDIR) -I$(AMREXDIR)/include -fdefault-real-8 -fdefault-double-8
F90WARNS  =

LIBS      = -lstdc++ -lamrex
LDFLAGS   = -L$(AMREXDIR)/lib
 
all:    $(COMMAND)

.SUFFIXES:
.SUFFIXES: .o .cpp .mod .F90

$(COMMAND): $(OBJS) $(MODS) $(MAKEFILE) 
	$(F90) -o $(COMMAND) $(OBJS) $(MODS) $(LDFLAGS) $(LIBS)

.cpp.o: $(CXX_HDRS) $(MAKEFILE)
	$(CXX) -c $(CXXFLAGS) $(CXXWARNS) -o $@ $<

.F90.mod: $(CXX_SRC) $(CXX_HDRS) $(MAKEFILE)
	$(F90) -c $(F90FLAGS) $(F90WARNS) -o $@ $<

clean:
	/bin/rm -f $(COMMAND) $(BASEDIR)/Test*.log
	/bin/rm -f $(COMMAND) $(SRCDIR)/*.o
	/bin/rm -f $(COMMAND) $(TESTDIR)/*.o
	/bin/rm -f $(COMMAND) $(SRCDIR)/*.mod
	/bin/rm -f $(COMMAND) $(BASEDIR)/*.mod
	/bin/rm -f $(COMMAND) $(TESTDIR)/*.mod

