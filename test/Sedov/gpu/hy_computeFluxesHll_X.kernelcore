${PROTECTIVE_PREAMBLE}

#include "Hydro.h"

${INCLUDE_ALGORITHM_HEADERS}

#include "Flash.h"

${KERNELCORE_ROUTINE_PREFIX} ${NS_PREFIX}computeFluxesHll_X${IMPL_SUFFIX}( $&
                                   ${ARGUMENT_SIGNATURE_tbduFa}            $&
				                                    ) ${BEGIN_KERNELROUTINE}
${DUMMY_ARGUMENT_DECLS_tbduFa}
${KERNELROUTINE_BOILERPLATE}

    Real    sL = 0.0;
    Real    sR = 0.0;
    Real    sRsL = 0.0;
    Real    vn = 0.0;
    Real    vL = 0.0;
    Real    vR = 0.0;
    int     is = 0;
    int     iL = 0;
    int     iR = 0;

    Real    invNewDens = 0.0_wp;

${DO_FOR_INTERIOR_XFACES}
                sL = std::min(U_d(i-1, j, k, VELX_VAR_C) - auxC_d(i-1, j, k, 0),  $&
                              U_d(i,   j, k, VELX_VAR_C) - auxC_d(i,   j, k, 0));
                sR = std::max(U_d(i-1, j, k, VELX_VAR_C) + auxC_d(i-1, j, k, 0),  $&
                              U_d(i,   j, k, VELX_VAR_C) + auxC_d(i,   j, k, 0));
                sRsL = sR - sL;
                if (sL > 0.0) ${then}
                    vn = U_d(i-1, j, k, VELX_VAR_C);
                    is = i - 1;
                    iL = i - 1;
                    iR = i - 1;
                ${elseif} (sR < 0.0) ${then}
                    vn = U_d(i, j, k, VELX_VAR_C);
                    is = i;
                    iL = i;
                    iR = i;
                ${else}
                    vn = 0.5_wp * (  U_d(i-1, j, k, VELX_VAR_C)  $&
                                   + U_d(i,   j, k, VELX_VAR_C));
                    is = i;
                    iL = i-1;
                    iR = i;
                    if (vn > 0.0) ${then}
                        --is;
                    ${endif}
                ${endif}

                vL = U_d(iL, j, k, VELX_VAR_C);
                vR = U_d(iR, j, k, VELX_VAR_C);
                if (iL == iR) ${then}
                    flX_d(i, j, k, HY_DENS_FLUX_C) =   vn * U_d(is, j, k, DENS_VAR_C);
                    flX_d(i, j, k, HY_XMOM_FLUX_C) =   vn * U_d(is, j, k, DENS_VAR_C)  $&
                                                              * U_d(is, j, k, VELX_VAR_C)  $&
                                                         +      U_d(is, j, k, PRES_VAR_C);
                    flX_d(i, j, k, HY_YMOM_FLUX_C) =   vn * U_d(is, j, k, DENS_VAR_C)  $&
                                                              * U_d(is, j, k, VELY_VAR_C);
                    flX_d(i, j, k, HY_ZMOM_FLUX_C) =   vn * U_d(is, j, k, DENS_VAR_C)  $&
                                                              * U_d(is, j, k, VELZ_VAR_C);
                    flX_d(i, j, k, HY_ENER_FLUX_C) =   vn * U_d(is, j, k, DENS_VAR_C)  $&
                                                              * U_d(is, j, k, ENER_VAR_C)  $&
                                                         + vn * U_d(is, j, k, PRES_VAR_C);
                ${else}
                    flX_d(i, j, k, HY_DENS_FLUX_C)  = (  sR * vL * U_d(iL, j, k, DENS_VAR_C)  $&
                                                           - sL * vR * U_d(iR, j, k, DENS_VAR_C)  $&
                                                           + sR*sL*(   U_d(iR, j, k, DENS_VAR_C)  $&
                                                                     - U_d(iL, j, k, DENS_VAR_C)) ) / sRsL;
                    flX_d(i, j, k, HY_XMOM_FLUX_C)  = (  sR * vL * U_d(iL, j, k, DENS_VAR_C) * U_d(iL, j, k, VELX_VAR_C)  $&
                                                           - sL * vR * U_d(iR, j, k, DENS_VAR_C) * U_d(iR, j, k, VELX_VAR_C)  $&
                                                           + sR*sL*(   U_d(iR, j, k, DENS_VAR_C) * U_d(iR, j, k, VELX_VAR_C)  $&
                                                                     - U_d(iL, j, k, DENS_VAR_C) * U_d(iL, j, k, VELX_VAR_C)) )/sRsL;
                    flX_d(i, j, k, HY_XMOM_FLUX_C)  = $&
                     flX_d(i, j, k, HY_XMOM_FLUX_C) + (  sR * U_d(iL, j, k, PRES_VAR_C)  $&
                                                           - sL * U_d(iR, j, k, PRES_VAR_C) ) /sRsL;
                    flX_d(i, j, k, HY_YMOM_FLUX_C)  = (  sR * vL * U_d(iL, j, k, DENS_VAR_C) * U_d(iL, j, k, VELY_VAR_C)  $&
                                                           - sL * vR * U_d(iR, j, k, DENS_VAR_C) * U_d(iR, j, k, VELY_VAR_C)  $&
                                                           + sR*sL*(   U_d(iR, j, k, DENS_VAR_C) * U_d(iR, j, k, VELY_VAR_C)  $&
                                                                     - U_d(iL, j, k, DENS_VAR_C) * U_d(iL, j, k, VELY_VAR_C)) )/sRsL;
                    flX_d(i, j, k, HY_ZMOM_FLUX_C)  = (  sR * vL * U_d(iL, j, k, DENS_VAR_C) * U_d(iL, j, k, VELZ_VAR_C)  $&
                                                           - sL * vR * U_d(iR, j, k, DENS_VAR_C) * U_d(iR, j, k, VELZ_VAR_C)  $&
                                                           + sR*sL*(   U_d(iR, j, k, DENS_VAR_C) * U_d(iR, j, k, VELZ_VAR_C)  $&
                                                                     - U_d(iL, j, k, DENS_VAR_C) * U_d(iL, j, k, VELZ_VAR_C)) )/sRsL;
                    flX_d(i, j, k, HY_ENER_FLUX_C)  = (  sR * vL * U_d(iL, j, k, DENS_VAR_C) * U_d(iL, j, k, ENER_VAR_C)  $&
                                                           - sL * vR * U_d(iR, j, k, DENS_VAR_C) * U_d(iR, j, k, ENER_VAR_C)  $&
                                                           + sR*sL*(   U_d(iR, j, k, DENS_VAR_C) * U_d(iR, j, k, ENER_VAR_C)  $&
                                                                     - U_d(iL, j, k, DENS_VAR_C) * U_d(iL, j, k, ENER_VAR_C)) )/sRsL;
                    flX_d(i, j, k, HY_ENER_FLUX_C)  = $&
                     flX_d(i, j, k, HY_ENER_FLUX_C) + (  sR * vL * U_d(iL, j, k, PRES_VAR_C)  $&
                                                           - sL * vR * U_d(iR, j, k, PRES_VAR_C)) / sRsL;
                ${endif}

                flX_d(i, j, k, HY_DENS_FLUX_C)  = flX_d(i, j, k, HY_DENS_FLUX_C)  *  dtdx
                flX_d(i, j, k, HY_XMOM_FLUX_C)  = flX_d(i, j, k, HY_XMOM_FLUX_C)  *  dtdx
                flX_d(i, j, k, HY_YMOM_FLUX_C)  = flX_d(i, j, k, HY_YMOM_FLUX_C)  *  dtdx
                flX_d(i, j, k, HY_ZMOM_FLUX_C)  = flX_d(i, j, k, HY_ZMOM_FLUX_C)  *  dtdx
                flX_d(i, j, k, HY_ENER_FLUX_C)  = flX_d(i, j, k, HY_ENER_FLUX_C)  *  dtdx
${END_DO_FOR_INTERIOR_CELLS}
${END_KERNELROUTINE}

