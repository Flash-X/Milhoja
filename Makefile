SHELL=/bin/sh


########################################################
# Makefile flags and defintions

MAKEFILE     = Makefile
MAKEFILES    = $(MAKEFILE) Makefile.site Makefile.base Makefile.test

# Must include site first so BASEDIR is defined.
include Makefile.site
include Makefile.base
include Makefile.test
include Makefile.setup

# Use C++11 standard, flags differ by compiler
ifeq ($(CXXCOMPNAME),gnu)
CXXFLAGS_STD = -std=c++11
DEPFLAG = -MMD
else ifeq ($(CXXCOMPNAME), pgi)
CXXFLAGS_STD = -std=c++11
DEPFLAG = -MMD$(@:.o=.d)
endif
CUFLAGS_STD  = -std=c++11


# Combine all compiler and linker flags
ifeq ($(DEBUG),true)
CXXFLAGS = $(CXXFLAGS_STD) $(CXXFLAGS_DEBUG) $(CXXFLAGS_BASE) $(CXXFLAGS_TEST) \
           $(CXXFLAGS_AMREX) -I$(BUILDDIR)
else
CXXFLAGS = $(CXXFLAGS_STD) $(CXXFLAGS_PROD) $(CXXFLAGS_BASE) $(CXXFLAGS_TEST) \
           $(CXXFLAGS_AMREX) -I$(BUILDDIR)
endif
CUFLAGS  = $(CUFLAGS_STD) $(CUFLAGS_PROD) $(CUFLAGS_BASE) $(CUFLAGS_TEST) \
	   $(CUFLAGS_AMREX) -I$(BUILDDIR)
LDFLAGS  = $(LDFLAGS_STD) $(LIB_AMREX) $(LDFLAGS_TEST)


# Add code coverage flags
ifeq ($(CODECOVERAGE), true)
CXXFLAGS += $(CXXFLAGS_COV)
LDFLAGS  += $(LDFLAGS_COV)
endif

# Adjust flags for multithreaded distributor
ifeq ($(THREADED_DISTRIBUTOR),true)
$(info Warning! multi-threaded distributor not tested yet)
AMREXDIR     = $(AMREXDIR_OMP)
CXXFLAGS    += $(OMP_FLAGS) $(OACC_FLAGS) -DUSE_THREADED_DISTRIBUTOR
CUFLAGS     += $(CU_OMP_FLAGS)
endif


# List of sources, objects, and dependencies
C_SRCS        = $(SRCS_BASE) $(SRCS_TEST)
C_OBJS_TEMP   = $(addsuffix .o, $(basename $(C_SRCS)))
C_OBJS        = $(patsubst $(BASEDIR)/%,$(OBJDIR)/%,$(C_OBJS_TEMP))

CU_OBJS_TEMP  = $(addsuffix .o, $(basename $(CU_SRCS)))
CU_OBJS       = $(patsubst $(BASEDIR)/%,$(OBJDIR)/%,$(CU_OBJS_TEMP))

OBJS = $(C_OBJS) $(CU_OBJS)
OBJTREE       = $(sort $(dir $(OBJS)))
DEPS          = $(OBJS:.o=.d)


# TODO: is this needed?
ifeq ($(DEBUG), true)
#CXXFLAGS += -DDEBUG_RUNTIME
endif

##########################################################
# Makefile commands:

.PHONY: default all clean test
default: $(BINARYNAME)
all:     $(BINARYNAME)
test:
	./$(BINARYNAME)


# Main make command depends on making all object files and creating object tree
# If code coverage is being build into the test, remove any previous gcda files to avoid conflict.
$(BINARYNAME): $(OBJS) $(MAKEFILES)
ifeq ($(CODECOVERAGE), true)
	/bin/rm -f $(addsuffix *.gcda,$(OBJTREE))
endif
	$(CXXCOMP) -o $(BINARYNAME) $(OBJS) $(LDFLAGS)

# -MMD generates a dependecy list for each file as a side effect
#  TODO : research different compiler equivalents to -MMD
$(OBJDIR)/%.o: $(BASEDIR)/%.cpp $(MAKEFILES) | $(OBJTREE)
	$(CXXCOMP) -c $(DEPFLAG) $(CXXFLAGS) -o $@ $<

$(OBJDIR)/%.o: $(BASEDIR)/%.cu $(MAKEFILES) | $(OBJTREE)
	$(CUCOMP) -MM $(CUFLAGS) -o $(@:.o=.d) $<
	$(CUCOMP) -c $(CUFLAGS) -o $@ $<

# Make directories in the object tree
$(OBJTREE):
	mkdir -p $@

# Clean removes all intermediate files
clean:
	/bin/rm -f $(addsuffix *.o,$(OBJTREE))
	/bin/rm -f $(addsuffix *.d,$(OBJTREE))
ifeq ($(CODECOVERAGE), true)
	/bin/rm -f $(addsuffix *.gcno,$(OBJTREE))
	/bin/rm -f $(addsuffix *.gcda,$(OBJTREE))
endif
	/bin/rm -f lcov_temp.info


.PHONY: coverage
coverage:
ifeq ($(CODECOVERAGE), true)
	$(LCOV) -o lcov_temp.info -c -d $(OBJDIR)
	$(GENHTML)  -o Coverage_Report lcov_temp.info
else
	$(info Include --coverage in your setup line to enable code coverage.)
endif


# Include dependencies generated by gcc
-include $(DEPS)

